<story-context id="0-3-configure-supabase-connection" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>0.3</storyId>
    <title>Configure Supabase Connection</title>
    <status>drafted</status>
    <generatedAt>s√∏ndag 30. november 2025</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/epic-0/story-0-3/0-3-configure-supabase-connection.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Developer</asA>
    <iWant>to set up the Supabase client in both frontend and backend</iWant>
    <soThat>the application can interact with the database and auth services.</soThat>
    <tasks>
    - [ ] AC 1: Supabase project creation/connection
      - [ ] Generate Supabase project URL and keys (if not already available)
      - [ ] Add instructions for connecting to an existing Supabase project.
    - [ ] AC 2: Environment variables configuration
      - [ ] Define `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY` in `frontend/.env.local`
      - [ ] Define `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_JWT_SECRET` in `backend/.env`
      - [ ] Ensure `.env` files are in `.gitignore`
    - [ ] AC 3: Backend database connection verification
      - [ ] Implement Supabase client initialization in `backend/app/core/` (e.g., `backend/app/core/database.py`)
      - [ ] Add a simple health check or startup log to confirm successful connection.
      - [ ] Write a basic unit test to verify backend Supabase client can connect.
    - [ ] AC 4: Frontend auth client initialization
      - [ ] Install `@supabase/supabase-js` in the frontend.
      - [ ] Initialize Supabase client in `frontend/lib/supabase.ts` (or similar).
      - [ ] Verify client initialization in browser console/logs.
    </tasks>
  </story>

  <acceptanceCriteria>
    1. Supabase project created (or instructions to connect to one)
    2. Environment variables configured (.env)
    3. Database connection verified from Backend
    4. Auth client initialized in Frontend
  </acceptanceCriteria>

  <artifacts>
    <docs>
        docs/epics.md#Story 0.3: Configure Supabase Connection
        docs/sprint-artifacts/tech-spec-epic-0.md#3.-Supabase-Connection
        docs/architecture.md#4.1.-Data-Flow-Pattern-(Frontend-Auth-+-Backend-Data)
        docs/architecture.md#7.-Security-&-Environment
        docs/architecture.md#2.-Project-Initialization-&-Structure
        docs/sprint-artifacts/tech-spec-epic-0.md#Test-Strategy-Summary
        stories/0-2-initialize-fastapi-backend.md#Dev-Agent-Record
    </docs>
    <code>
        frontend/.env.local (new file)
        backend/.env (new file)
        backend/app/core/ (for Supabase client initialization)
        frontend/lib/ (for Supabase client initialization)
        backend/tests/ (for connection verification test)
        backend/pyproject.toml (for dependencies)
        frontend/package.json (for dependencies)
    </code>
    <dependencies>
        Frontend: `@supabase/supabase-js`
        Backend: `supabase`, `python-dotenv`
    </dependencies>
  </artifacts>

  <constraints>
    Data Flow Pattern: Frontend talks directly to Supabase Auth. Backend handles all data access via a service role key and validates JWTs from frontend requests. Frontend *never* queries the database directly.
    Secrets Management: All `.env` files containing Supabase keys must be ignored by Git. `SUPABASE_SERVICE_ROLE_KEY` should only be used in the backend.
    Project Structure: Monorepo with `frontend/` and `backend/` directories.
    Environment: Local development with Next.js on port 3000 and FastAPI on port 8000.
  </constraints>
  <interfaces>
    Environment Variables (.env):
        Frontend (.env.local): `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`
        Backend (.env): `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_JWT_SECRET`
    Backend Health Check: A standard `GET /health` or `GET /` endpoint to verify the API is running and accessible.
    Database Connectivity Check: A script or startup log entry confirming successful connection to Supabase.
  </interfaces>
  <tests>
    <standards>
        Verification Method: Manual "Smoke Test" of the environment.
        Backend: Startup connection logs and a basic unit test to ensure connectivity.
        Frontend: Console log checks for successful client initialization.
        Security: Verify `.env` files are not committed to Git.
    </standards>
    <locations>
        backend/tests/
        Browser console/network tab for frontend.
        Server console for backend startup logs.
    </locations>
    <ideas>
        Verify Supabase project creation (manual check of Supabase dashboard).
        Check for correct environment variable loading in both frontend and backend.
        Execute a simple `curl` command to a backend endpoint that attempts to connect to Supabase (if implemented).
        Verify console logs in frontend for successful Supabase client initialization.
    </ideas>
  </tests>
</story-context>
