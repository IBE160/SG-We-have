<story-context id="epic-1-story-1-2-context" v="1.0">
  <metadata>
    <epicId>epic-1</epicId>
    <storyId>1-2</storyId>
    <title>User Login & Logout</title>
    <status>drafted</status>
    <generatedAt>2025-12-01</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/epic-1/story-1-2/story-1-2.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Registered student</asA>
    <iWant>securely log in and out</iWant>
    <soThat>I can access my personalized study environment.</soThat>
    <tasks>
      <task name="Frontend: Create LoginPage Component">
        <subtasks>
          <subtask>Design and implement UI for login form (email, password inputs, submit button)</subtask>
          <subtask>Integrate supabase.auth.signInWithPassword function on form submission</subtask>
          <subtask>Handle successful login (redirect to dashboard) and errors (display message)</subtask>
        </subtasks>
      </task>
      <task name="Frontend: Implement AuthContext and SupabaseClientProvider">
        <subtasks>
          <subtask>Set up Supabase client in lib/supabase.ts (reuse existing if available)</subtask>
          <subtask>Create an AuthContext to provide user session globally</subtask>
          <subtask>Utilize onAuthStateChange to update context and manage session</subtask>
          <subtask>Wrap application with SupabaseClientProvider in app/layout.tsx</subtask>
        </subtasks>
      </task>
      <task name="Frontend: Implement Logout Functionality">
        <subtasks>
          <subtask>Add a logout button (e.g., in Navbar)</subtask>
          <subtask>Call supabase.auth.signOut() on click</subtask>
          <subtask>Redirect to login page after logout</subtask>
        </subtasks>
      </task>
      <task name="Frontend: Protect Routes">
        <subtasks>
          <subtask>In app/layout.tsx or middleware, check for active session. If no session, redirect to /login</subtask>
        </subtasks>
      </task>
      <task name="Backend: Develop JWT Validation Middleware">
        <subtasks>
          <subtask>Create a dependency in backend/app/core/security.py to extract and validate the JWT token from Authorization header</subtask>
          <subtask>Use SUPABASE_JWT_SECRET for verification</subtask>
          <subtask>Inject user_id into request context</subtask>
        </subtasks>
      </task>
      <task name="Backend: Apply Middleware to Protected Endpoints">
        <subtasks>
          <subtask>Ensure all relevant api endpoints use this JWT validation dependency</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion>User can enter credentials to log in.</criterion>
    <criterion>System rejects invalid credentials with an appropriate error message.</criterion>
    <criterion>User can log out from any page.</criterion>
    <criterion>Accessing protected routes (Dashboard) without a session redirects to Login.</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: User Foundation & Course Management</title>
        <section>Detailed Design / APIs and Interfaces</section>
        <snippet>
          Frontend: AuthContext, SupabaseClientProvider.
          Backend: Core/Security for JWT validation.
          APIs: supabase.auth.signInWithPassword, supabase.auth.signOut.
        </snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Scale Adaptive Architecture</title>
        <section>4.1. Data Flow Pattern (Frontend Auth + Backend Data)</section>
        <snippet>
          Authentication: Frontend talks directly to Supabase Auth.
          Data Access: Frontend MUST include Authorization: Bearer token header. Backend Middleware validates JWT.
        </snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/epic-1/story-1-1/1-1-user-registration.md</path>
        <title>Story 1.1: User Registration</title>
        <section>Learnings</section>
        <snippet>Reuse frontend/lib/supabase.ts. Ensure Login flow integrates with existing profiles table triggers.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Functional Requirements / User Journeys</section>
        <snippet>FR001: User Authentication. User Journey 1: Fiona logs in with new credentials and sees dashboard.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 1: User Foundation & Course Management</section>
        <snippet>Story 1.2: User Login & Logout. AC: System authenticates user and grants access. User can log out from any page.</snippet>
      </doc>
    </docs>
    
    <code>
      <item>
        <path>frontend/lib/supabase.ts</path>
        <kind>file</kind>
        <symbol>supabase</symbol>
        <reason>Existing Supabase client initialization to be reused.</reason>
      </item>
      <item>
        <path>frontend/app/register/page.tsx</path>
        <kind>component</kind>
        <symbol>RegisterPage</symbol>
        <reason>Reference implementation for auth forms.</reason>
      </item>
      <item>
        <path>supabase/migrations/20251201000000_create_profiles.sql</path>
        <kind>database</kind>
        <symbol>profiles</symbol>
        <reason>Target table that should be populated (via trigger) for logged in users.</reason>
      </item>
    </code>

    <dependencies>
      <ecosystem name="npm">
        <package>@supabase/supabase-js</package>
        <package>zustand</package>
        <package>lucide-react</package>
      </ecosystem>
      <ecosystem name="python">
        <package>fastapi</package>
        <package>pydantic</package>
        <package>python-jose</package> <!-- Assumed for JWT validation -->
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Frontend Auth: Adhere to the pattern where Frontend talks directly to Supabase Auth.</constraint>
    <constraint>Token Validation: Backend must blindly trust valid JWTs signed by Supabase (stateless auth).</constraint>
    <constraint>No Direct DB Access: Frontend never queries the Database directly.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>supabase.auth.signInWithPassword</name>
      <kind>function</kind>
      <signature>(credentials: SignInWithPasswordCredentials) => Promise&lt;AuthResponse&gt;</signature>
    </interface>
    <interface>
      <name>supabase.auth.signOut</name>
      <kind>function</kind>
      <signature>() => Promise&lt;{ error: AuthError | null }&gt;</signature>
    </interface>
    <interface>
      <name>JWT Validation Middleware</name>
      <kind>backend-dependency</kind>
      <signature>get_current_user(token: str = Depends(oauth2_scheme))</signature>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Frontend: Test components render and interact with mocked Supabase client.
      Backend: Test middleware extracts and validates tokens correctly.
    </standards>
    <locations>
      frontend/__tests__
      backend/tests
    </locations>
    <ideas>
      <idea>Verify login with valid credentials redirects to dashboard.</idea>
      <idea>Verify login with invalid credentials shows error message.</idea>
      <idea>Verify clicking logout clears session and redirects to login.</idea>
      <idea>Call a protected endpoint without a token and verify 401 response.</idea>
    </ideas>
  </tests>
</story-context>
