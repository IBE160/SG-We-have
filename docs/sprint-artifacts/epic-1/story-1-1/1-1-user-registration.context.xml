<story-context id="1-1-user-registration" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1</storyId>
    <title>User Registration</title>
    <status>drafted</status>
    <generatedAt>2025-12-01</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/epic-1/story-1-1/1-1-user-registration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>new student</asA>
    <iWant>create an account</iWant>
    <soThat>I can access the application's features and save my data.</soThat>
    <tasks>
- [ ] **AC 9: Deploy Database Schema and RLS**
  - [ ] Execute SQL script in Supabase Dashboard for `profiles` table creation.
  - [ ] Verify Row Level Security policies are enabled for `profiles`.
  - [ ] Confirm `handle_new_user()` trigger is active for `auth.users` inserts.
- [ ] **AC 1, 2, 3: Implement Registration UI and Client-side Validation**
  - [ ] Create `frontend/app/register/page.tsx` with email and password input fields.
  - [ ] Implement client-side validation for email format and password length (min 6 chars).
  - [ ] Display clear error messages for invalid input.
- [ ] **AC 4, 6, 7: Handle Supabase Registration and Redirection**
  - [ ] Integrate `supabase.auth.signUp({ email, password })` using `frontend/lib/supabase.ts`.
  - [ ] Upon successful registration, redirect user to `/dashboard`.
  - [ ] Implement error handling to display user-friendly messages for Supabase-related errors (e.g., "User already exists").
- [ ] **AC 8: Add Navigation**
  - [ ] Add a link to the Login page (`/login`) on the registration page.
- [ ] **AC 1-9: Manual Verification and Testing**
  - [ ] Manually sign up a new user via the UI.
  - [ ] Verify new user appears in Supabase `auth.users` table.
  - [ ] Verify corresponding profile appears in Supabase `public.profiles` table.
  - [ ] Test error conditions (e.g., invalid email, too short password, existing user).
  - [ ] Confirm successful redirection to `/dashboard`.</tasks>
  </story>

  <acceptanceCriteria>
1.  **Registration Form:** A dedicated registration page (`/register`) exists.
2.  **Input Fields:** Users can enter Email and Password.
3.  **Validation:** Email must be valid. Password must be at least 6 characters (Supabase default). Form shows clear error messages for invalid input.
4.  **Submission:** Submitting the form creates a user in Supabase Auth.
5.  **Profile Creation:** A corresponding row is created in the `profiles` table (via Database Trigger).
6.  **Success State:** Upon successful registration, the user is automatically logged in and redirected to the Dashboard (`/dashboard`).
7.  **Error Handling:** If registration fails (e.g., user already exists), a user-friendly error message is displayed.
8.  **Navigation:** Link to "Login" page is available for existing users.
9.  **Database Setup:** The `profiles` table and necessary Row Level Security (RLS) policies are deployed in Supabase.</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>ibe160 Product Requirements Document (PRD)</title>
        <section>Functional Requirements</section>
        <snippet>FR001: User Authentication: The system shall provide sign-up, login, and logout functionality for users.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>ibe160 Product Requirements Document (PRD)</title>
        <section>User Journey 1: New User Onboarding and First Note-Taking Session</section>
        <snippet>Scenario: Fiona, a new user, wants to start organizing her study materials and needs to capture notes from a recent lecture. Actions: Sign Up, Enter credentials, Create account, Redirected to login page. Logs in successfully.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: User Foundation &amp; Course Management</title>
        <section>Detailed Design</section>
        <snippet>Services and Modules: Supabase Auth (User Identity, JWT issuance), Frontend / Auth (Login/Register forms, Session Context).</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: User Foundation &amp; Course Management</title>
        <section>Detailed Design</section>
        <snippet>Data Models (Database Schema): `profiles` table with `id` (PK, FK `auth.users.id`), `full_name`, `email`.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: User Foundation &amp; Course Management</title>
        <section>Security: Row Level Security (RLS) Policies</section>
        <snippet>`profiles`: `SELECT`: Users can see their own profile. `auth.uid() = id`. `UPDATE`: Users can update their own profile. `INSERT`: Users can insert their own profile.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: User Foundation &amp; Course Management</title>
        <section>Frontend Routes (Next.js)</section>
        <snippet>`/login` - Public. Login form. `/register` - Public. Registration form.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: User Foundation &amp; Course Management</title>
        <section>Acceptance Criteria (Authoritative)</section>
        <snippet>1. User Registration: User can sign up with email/password. User is redirected to Dashboard after signup. `profiles` row is created (via trigger or manual call).</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: User Foundation &amp; Course Management</title>
        <section>Traceability Mapping</section>
        <snippet>User Story 1.1 Registration | Component FE/Auth | Test Strategy Manual: Sign up new user, check DB `auth.users`.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Scale Adaptive Architecture: AI-Powered Student Helper</title>
        <section>4.1. Data Flow Pattern (Frontend Auth + Backend Data)</section>
        <snippet>Authentication: Frontend talks *directly* to Supabase Auth to login/signup. Supabase returns a JWT (Access Token). Frontend stores this token.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Scale Adaptive Architecture: AI-Powered Student Helper</title>
        <section>7. Security &amp; Environment</section>
        <snippet>Environment Variables: `frontend/.env.local`: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`. RLS (Row Level Security): Enable RLS on Supabase tables to prevent accidental public access.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Scale Adaptive Architecture: AI-Powered Student Helper</title>
        <section>2. Project Initialization &amp; Structure</section>
        <snippet>The project follows a Monorepo structure. Source Tree shows `frontend/` with `app/` and `lib/` for components and utilities.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Epic 1: User Foundation &amp; Course Management</section>
        <snippet>Story 1.1: User Registration - As a new student, I want to create an account, so that I can access the application's features. Acceptance Criteria: User can provide a unique username and password. System validates input and creates a new user account. User receives confirmation.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>frontend/app/register/page.tsx</path>
        <kind>component</kind>
        <symbol>RegistrationPage</symbol>
        <reason>New page component for user registration UI.</reason>
        <line>1</line>
      </artifact>
      <artifact>
        <path>frontend/lib/supabase.ts</path>
        <kind>utility</kind>
        <symbol>supabase</symbol>
        <reason>Supabase client instance used for authentication (signUp function).</reason>
        <line>9</line>
      </artifact>
      <artifact>
        <path>supabase/migrations/0000_create_profiles_table.sql</path>
        <kind>database migration</kind>
        <reason>Conceptual path for the SQL script to create `profiles` table and trigger `handle_new_user`.</reason>
        <line>1</line>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="Node.js">
        <package name="next" reason="Frontend framework" />
        <package name="react" reason="Frontend library" />
        <package name="@supabase/supabase-js" reason="Supabase client for authentication" />
      </ecosystem>
      <ecosystem name="Python">
        <package name="supabase" reason="Supabase Python client for potential future backend profile management" />
        <package name="fastapi" reason="Backend framework (not directly used for registration flow, but part of overall project)" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Monorepo Pattern: Frontend (`frontend/`) and Backend (`backend/`) exist at the project root.</constraint>
    <constraint>Data Flow Pattern: Frontend talks directly to Supabase Auth for user registration.</constraint>
    <constraint>Supabase Authentication: User management and JWT issuance handled by Supabase.</constraint>
    <constraint>Row Level Security (RLS): RLS policies must be applied to the `profiles` table.</constraint>
    <constraint>Password Validation: Minimum 6 characters for password (Supabase default).</constraint>
    <constraint>No Direct DB Access from Frontend: Frontend must not query the database directly.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Registration Page</name>
      <kind>Frontend Route</kind>
      <signature>GET /register</signature>
      <path>frontend/app/register/page.tsx</path>
    </interface>
    <interface>
      <name>Login Page Navigation</name>
      <kind>Frontend Route</kind>
      <signature>GET /login</signature>
      <path>frontend/app/login/page.tsx</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Manual end-to-end testing of the registration flow via the UI. Direct inspection of Supabase `auth.users` and `public.profiles` tables. UI/UX validation for error messages and redirection.
    </standards>
    <locations>
      <location>frontend/</location>
      <location>Supabase Dashboard</location>
    </locations>
    <ideas>
      <idea>Manually sign up a new user via the UI.</idea>
      <idea>Verify new user appears in Supabase `auth.users` table.</idea>
      <idea>Verify corresponding profile appears in Supabase `public.profiles` table.</idea>
      <idea>Test error conditions (e.g., invalid email, too short password, existing user).</idea>
      <idea>Confirm successful redirection to `/dashboard`.</idea>
    </ideas>
  </tests>
</story-context>
