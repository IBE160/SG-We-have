<story-context id="docs/sprint-artifacts/epic-4/story-4-2-immediate-answer-feedback/4-2-immediate-answer-feedback.context.xml" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>4-2</storyId>
    <title>Immediate Answer Feedback</title>
    <status>drafted</status>
    <generatedAt>2025-12-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/epic-4/story-4-2-immediate-answer-feedback/4-2-immediate-answer-feedback.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Student</asA>
    <iWant>to receive immediate feedback (green/red) after selecting an answer to a quiz question</iWant>
    <soThat>I know if I was correct or not and can learn instantly.</soThat>
    <tasks>
- [ ] **Backend - Data Models:** Define `QuizSubmissionRequest` (answer_id) and `QuizSubmissionResponse` (is_correct, correct_answer_id, feedback_text) Pydantic models in `backend/app/models/quiz_submission.py`. (AC: #1)
- [ ] **Backend - Service Logic:** Implement `submit_answer` logic in `backend/app/services/quiz_submission.py` to validate answer, record in `quiz_answers` table, and return result. (AC: #1)
- [ ] **Backend - API Endpoint:** Implement `POST /api/v1/quiz/{quiz_id}/answer` endpoint in `backend/app/api/routers/quiz.py`. (AC: #1)
- [ ] **Frontend - API Service:** Implement `submitAnswer` method in `QuizService` (`frontend/lib/services/quiz.ts`) calling the backend endpoint. (AC: #1)
- [ ] **Frontend - Component Logic:** Update `QuizPlayer` component to handle answer selection, invoke `submitAnswer`, and store the result state. (AC: #1)
- [ ] **Frontend - UI Feedback:** Apply conditional styling (green for correct, red for chosen incorrect) to answer buttons and display feedback text below the question. (AC: #1, #2)
- [ ] **Test - Backend:** Write unit tests for `submit_answer` service logic and API endpoint integration in `backend/tests/`. (AC: #1)
- [ ] **Test - Frontend:** Write component tests for `QuizPlayer` verifying feedback rendering and API interaction in `frontend/tests/`. (AC: #1, #2)
    </tasks>
  </story>

  <acceptanceCriteria>
1. Upon selecting an answer, the correct option is highlighted green and incorrect options red.
2. Feedback is displayed clearly (e.g., "Correct!" or "Incorrect, the correct answer was..."). (FR012)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Functional Requirements</section>
        <snippet>FR012: Immediate Feedback: The system shall provide immediate feedback on answers (correct = green, incorrect = red).</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>Story 4.2: Immediate Answer Feedback</section>
        <snippet>Provides detailed acceptance criteria and tasks for implementing immediate feedback. Specifies architectural alignment with QuizPlayer and QuizSubmission service.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Scale Adaptive Architecture</title>
        <section>4.1. Data Flow Pattern</section>
        <snippet>Frontend calls FastAPI Backend for ALL data. Backend Middleware validates JWT. Backend returns JSON data. Frontend never queries DB directly.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>frontend/app/quiz/[quizId]/page.tsx</path>
        <kind>page</kind>
        <symbol>QuizPage</symbol>
        <reason>Quiz Player container component that manages quiz state and renders the question display.</reason>
      </file>
      <file>
        <path>frontend/components/QuizQuestionDisplay.tsx</path>
        <kind>component</kind>
        <symbol>QuizQuestionDisplay</symbol>
        <reason>Base component to update for showing feedback state (green/red highlights).</reason>
      </file>
      <file>
        <path>frontend/lib/services/quiz.ts</path>
        <kind>service</kind>
        <symbol>QuizService</symbol>
        <reason>Client-side service to extend with submitAnswer method.</reason>
      </file>
      <file>
        <path>backend/app/api/routers/quiz.py</path>
        <kind>router</kind>
        <symbol>router</symbol>
        <reason>FastAPI router to add POST /answer endpoint.</reason>
      </file>
      <file>
        <path>backend/app/services/quiz_submission.py</path>
        <kind>service</kind>
        <symbol>start_quiz_attempt</symbol>
        <reason>Service logic to extend with submit_answer function.</reason>
      </file>
      <file>
        <path>backend/app/models/quiz_submission.py</path>
        <kind>model</kind>
        <symbol>QuizAttempt</symbol>
        <reason>Pydantic models file to add QuizSubmissionRequest and Response.</reason>
      </file>
    </code>
    <dependencies>
      <package name="fastapi" version=">=0.122.0" ecosystem="python" />
      <package name="pydantic" version=">=2.12.5" ecosystem="python" />
      <package name="supabase" version=">=2.24.0" ecosystem="python" />
      <package name="@tanstack/react-query" version="^5.90.11" ecosystem="npm" />
      <package name="clsx" version="^2.1.1" ecosystem="npm" />
      <package name="tailwind-merge" version="^3.4.0" ecosystem="npm" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      Frontend: Use Next.js 15.x App Router and Tailwind CSS for styling.
    </constraint>
    <constraint>
      State: Use React Query for API mutations. Use local component state for immediate UI feedback.
    </constraint>
    <constraint>
      Security: Backend must verify the answer belongs to the current quiz attempt and authenticated user.
    </constraint>
    <constraint>
      Naming: Follow snake_case for Python/DB and PascalCase/camelCase for TypeScript/React.
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Submit Answer API</name>
      <kind>REST Endpoint</kind>
      <signature>POST /api/v1/quiz/{quiz_id}/answer</signature>
      <path>backend/app/api/routers/quiz.py</path>
    </interface>
    <interface>
      <name>QuizSubmissionRequest</name>
      <kind>Pydantic Model</kind>
      <signature>class QuizSubmissionRequest(BaseModel): answer_id: str</signature>
      <path>backend/app/models/quiz_submission.py</path>
    </interface>
    <interface>
      <name>QuizSubmissionResponse</name>
      <kind>Pydantic Model</kind>
      <signature>class QuizSubmissionResponse(BaseModel): is_correct: bool, correct_answer_id: str, feedback_text: str</signature>
      <path>backend/app/models/quiz_submission.py</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Backend: Pytest with async support for service logic and API endpoints.
      Frontend: Jest + React Testing Library for component interactions.
    </standards>
    <locations>
      <location>backend/tests/</location>
      <location>frontend/tests/</location>
    </locations>
    <ideas>
      <idea id="1">Unit test `submit_answer` service: verify score update and correct feedback.</idea>
      <idea id="2">Component test `QuizQuestionDisplay`: verify styling changes (green/red) based on answer correctness props.</idea>
    </ideas>
  </tests>
</story-context>
